stages:
  - build_and_deploy

deploy_client_customer:
  stage: build_and_deploy
  tags:
    - shell
  variables:
    DEPLOY_PATH: "/opt/apps/aliconcon-ecommerce_client-customer"
  before_script:
    - source /home/gitlab-runner/.bashrc

  script:
    - echo "ğŸš€ Starting deployment script..."
    - pwd
    - ls -la

    # 1. Install dependencies
    - echo "ğŸ“¦ Installing dependencies..."
    - bun install

    # 2. Build application
    - echo "ğŸ”¨ Building application..."
    - bun run build
    - echo "ğŸ“‚ Checking build output..."
    # Quoting carefully to avoid issues with specialized characters
    - 'ls -la .next/standalone || echo "âŒ Error: .next/standalone not found!"'

    # 3. Prepare directory
    - echo "ğŸ“‚ Preparing deployment directory: $DEPLOY_PATH"
    - mkdir -p $DEPLOY_PATH

    # 4. Deploy Standalone Artifacts (Local Copy)
    - echo "ğŸšš Syncing files to deployment directory..."
    # Copy standalone build
    - rsync -rlptDv --delete .next/standalone/ $DEPLOY_PATH/
    # Copy static files (standalone doesn't include them by default)
    - rsync -rlptDv .next/static/ $DEPLOY_PATH/.next/static/
    - rsync -rlptDv public/ $DEPLOY_PATH/public/
    # Copy ecosystem config
    - rsync -rlptDv ecosystem.config.cjs $DEPLOY_PATH/

    # 5. Restart PM2
    - echo "ğŸ”„ Restarting PM2 process..."
    - cd $DEPLOY_PATH
    - pm2 startOrRestart ecosystem.config.cjs

  only:
    - main
    - master
