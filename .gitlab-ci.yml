stages:
  - build_and_deploy

deploy_client_customer:
  stage: build_and_deploy
  tags:
    - shell
  variables:
    DEPLOY_PATH: "/opt/apps/aliconcon-ecommerce_client-customer"

  script:
    # 1. Install dependencies
    - bun install

    # 2. Build application
    - bun run build

    # 3. Prepare directory
    - mkdir -p $DEPLOY_PATH

    # 4. Deploy Standalone Artifacts (Local Copy)
    # Use -rlptDv to copy recursion, links, perms, times, devices, verbose. 
    # Skip -o (owner) and -g (group) to avoid permission errors if runner is different user.
    - rsync -rlptDv --delete .next/standalone/ $DEPLOY_PATH/
    - rsync -rlptDv .next/static/ $DEPLOY_PATH/.next/static/
    - rsync -rlptDv public/ $DEPLOY_PATH/public/

    # 5. Restart PM2
    - cd $DEPLOY_PATH
    - pm2 restart client-customer || pm2 start server.js --name client-customer

  only:
    - main
    - master
