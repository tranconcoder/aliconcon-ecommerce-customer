include:
  - project: tvconss/gitlab-tools
    ref: main
    file: sync-to-github/.gitlab-ci.yml

stages:
  - sync-to-github
  - build_and_deploy

variables:
  GITHUB_REPO: "aliconcon-ecommerce-customer"

deploy_client_customer:
  stage: build_and_deploy
  image: docker:latest
  needs: []
  variables:
    DOCKER_HOST: unix:///var/run/docker.sock
    CONTAINER_NAME: "aliconcon-client-customer"
    IMAGE_NAME: "aliconcon-client-customer"
    APP_PORT: "3000"
  before_script:
    - docker info

  script:
    # 1. Build Docker image
    - echo "ðŸ”¨ Building Docker image..."
    - docker build -t $IMAGE_NAME .

    # 2. Stop and remove existing container if exists
    - echo "ï¿½ Removing old container..."
    - docker rm -f $CONTAINER_NAME || true

    # 3. Run new container with restart policy
    - echo "ï¿½ Starting container..."
    - docker run -d
      --name $CONTAINER_NAME
      --restart unless-stopped
      -p $APP_PORT:3000
      $IMAGE_NAME

    - echo "âœ… Deployment complete!"

  only:
    - main
    - master

  tags:
    - docker
